<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RO/ARO Exam Portal - NTA Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; }
        .hidden-all { display: none !important; }
        
        /* NTA Colors */
        .nta-blue { background: linear-gradient(135deg, #003366 0%, #004080 100%); }
        .nta-orange { background: #FF9933; }
        .nta-green { background: #28a745; }
        
        /* Password Page */
        .password-container {
            background: linear-gradient(135deg, #003366 0%, #004080 50%, #0059b3 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .password-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 420px;
            overflow: hidden;
        }
        .password-header {
            background: linear-gradient(135deg, #003366 0%, #004080 100%);
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .password-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #FF9933 0%, #FF9933 33%, #ffffff 33%, #ffffff 66%, #138808 66%, #138808 100%);
        }
        .nta-logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .nta-logo-inner {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #FF9933 0deg 120deg, #ffffff 120deg 240deg, #138808 240deg 360deg);
        }
        
        /* Palette Buttons */
        .palette-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            background: white;
            color: #333;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
        }
        .palette-btn:hover { transform: scale(1.1); }
        .palette-not-visited { background: #f8f9fa; border-color: #adb5bd; color: #6c757d; }
        .palette-not-answered { background: #dc3545; border-color: #dc3545; color: white; }
        .palette-answered { background: #28a745; border-color: #28a745; color: white; }
        .palette-marked { background: #6f42c1; border-color: #6f42c1; color: white; }
        .palette-answered-marked { 
            background: #6f42c1; 
            border-color: #28a745; 
            color: white;
            position: relative;
        }
        .palette-answered-marked::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
        }
        .palette-current { 
            box-shadow: 0 0 0 3px #FF9933, 0 0 10px rgba(255,153,51,0.5);
            transform: scale(1.15);
        }
        
        /* Options */
        .option-label {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-label:hover { background: #f8f9fa; border-color: #adb5bd; }
        .option-label.selected { 
            background: #e3f2fd; 
            border-color: #2196f3;
            box-shadow: 0 2px 8px rgba(33,150,243,0.2);
        }
        .option-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f8f9fa;
            border: 2px solid #adb5bd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 14px;
            font-weight: bold;
            color: #495057;
        }
        .option-label.selected .option-circle {
            background: #2196f3;
            border-color: #2196f3;
            color: white;
        }
        
        /* Timer */
        .timer-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        /* Loading */
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #003366;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Buttons */
        .btn-nta {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-save-next { background: #28a745; color: white; }
        .btn-save-review { background: #ffc107; color: #212529; }
        .btn-clear { background: #6c757d; color: white; }
        .btn-mark-review { background: #6f42c1; color: white; }
        .btn-submit { background: #dc3545; color: white; }
        .btn-proceed { background: #003366; color: white; padding: 14px 40px; font-size: 1.1rem; }
        .btn-proceed:hover { background: #002244; transform: translateY(-2px); }
    </style>
<base target="_blank">
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- ==================== PASSWORD PAGE ==================== -->
    <div id="passwordOverlay" class="password-container">
        <div class="password-card">
            <div class="password-header">
                <div class="nta-logo">
                    <div class="nta-logo-inner"></div>
                </div>
                <h1 class="text-white text-xl font-bold">RO/ARO EXAM PORTAL</h1>
                <p class="text-blue-200 text-sm mt-1">Uttar Pradesh Public Service Commission</p>
            </div>
            <div class="p-8">
                <h2 class="text-center text-gray-800 text-lg font-semibold mb-2">Secure Login</h2>
                <p class="text-center text-gray-500 text-sm mb-6">Enter password to access the exam</p>
                <div class="relative mb-4">
                    <i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-blue-800"></i>
                    <input type="password" id="sitePass" class="w-full p-4 pl-12 border-2 border-gray-200 rounded-xl text-lg focus:border-blue-600 focus:outline-none" placeholder="Enter Password">
                </div>
                <button onclick="checkPass()" class="w-full btn-nta btn-proceed">
                    <i class="fas fa-unlock-alt mr-2"></i>Access Test
                </button>
                <div id="passError" class="hidden mt-4 p-3 bg-red-100 text-red-600 rounded-lg text-center text-sm">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Incorrect password!
                </div>
                <div class="flex items-center justify-center gap-2 mt-6 text-gray-400 text-xs">
                    <i class="fas fa-shield-alt text-green-500"></i>
                    <span>256-bit SSL Secured</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== NAME SECTION ==================== -->
    <div id="nameSection" class="hidden-all min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="nta-blue text-white p-4 text-center">
                <h2 class="text-xl font-bold"><i class="fas fa-user mr-2"></i>Candidate Details</h2>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Candidate Name</label>
                    <input type="text" id="candidateName" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Enter your full name">
                </div>
                <button onclick="proceedToSubject()" class="w-full btn-nta btn-proceed mt-4">
                    <i class="fas fa-arrow-right mr-2"></i>Continue
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== LOADING SECTION ==================== -->
    <div id="loadingSection" class="hidden-all min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-xl font-semibold text-gray-700">Loading Questions...</p>
        </div>
    </div>

    <!-- ==================== SUBJECT SELECTION ==================== -->
    <div id="subjectSection" class="hidden-all min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="nta-orange text-white p-4 text-center">
                <h2 class="text-xl font-bold"><i class="fas fa-book mr-2"></i>Select Exam Details</h2>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Subject</label>
                    <select id="mainSubject" onchange="updateSubSubjects()" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none">
                        <option value="">-- Select Subject --</option>
                    </select>
                </div>
                <div id="subSubjectContainer" class="hidden">
                    <label class="block text-gray-700 font-semibold mb-2">Sub-Subject / Topic</label>
                    <select id="subSubject" onchange="updateQuestionCount()" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none">
                        <option value="">-- All Topics --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Number of Questions</label>
                    <select id="questionCount" onchange="updateTimeDisplay()" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none">
                        <option value="">-- Select --</option>
                        <option value="100">100 Questions (100 Minutes)</option>
                        <option value="200">200 Questions (200 Minutes)</option>
                        <option value="all">All Available Questions</option>
                    </select>
                </div>
                <div id="timeDisplay" class="hidden bg-blue-50 p-3 rounded-lg text-center">
                    <p class="text-blue-800 font-semibold"><i class="fas fa-clock mr-2"></i>Total Time: <span id="totalTime">--</span></p>
                    <p class="text-xs text-blue-600 mt-1">(1 minute per question)</p>
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Language</label>
                    <select id="languageSelect" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none">
                        <option value="hi">हिंदी (Hindi)</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <button onclick="startExam()" class="w-full btn-nta btn-proceed mt-4">
                    <i class="fas fa-play mr-2"></i>Start Exam
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== INSTRUCTIONS SECTION ==================== -->
    <div id="instructionSection" class="hidden-all">
        <div class="nta-blue text-white p-4">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-orange-400 to-green-500"></div>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">RO/ARO EXAM PORTAL</h1>
                        <p class="text-xs text-blue-200">UPPSC Mock Test</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="nta-orange text-white p-3">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-lg font-bold">GENERAL INSTRUCTIONS</h2>
            </div>
        </div>
        
        <div class="max-w-5xl mx-auto p-6">
            <h3 class="text-xl font-bold text-center mb-6">Please read the instructions carefully</h3>
            
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h4 class="font-bold text-lg mb-4">General Instructions:</h4>
                <ol class="list-decimal list-inside space-y-3 text-gray-700">
                    <li>Total duration is <span id="instrTotalTime" class="font-bold text-blue-600">--</span> based on selected questions (1 min per question).</li>
                    <li>The countdown timer displays remaining time in top right corner.</li>
                    <li>When timer reaches zero, exam will auto-submit.</li>
                    <li>Question Palette shows status of each question:</li>
                </ol>
                
                <div class="mt-6 grid md:grid-cols-2 gap-4 text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded bg-gray-400 border-2 border-gray-400"></div>
                        <span>You have <strong>not visited</strong> the question yet.</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded bg-red-500 border-2 border-red-500"></div>
                        <span>You have <strong>not answered</strong> the question.</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded bg-green-500 border-2 border-green-500"></div>
                        <span>You have <strong>answered</strong> the question.</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded bg-purple-600 border-2 border-purple-600"></div>
                        <span>Marked for <strong>review</strong>.</span>
                    </div>
                </div>
                
                <div class="mt-6 text-gray-700">
                    <p class="mb-2 font-bold">Marking Scheme:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><span class="text-green-600 font-bold">+1 Mark</span> for each correct answer</li>
                        <li><span class="text-red-600 font-bold">-1/3 Mark</span> (0.33 negative) for each wrong answer</li>
                        <li><span class="text-gray-600 font-bold">0 Mark</span> for unattempted questions</li>
                    </ul>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <label class="flex items-start gap-3 cursor-pointer">
                    <input type="checkbox" id="declaration" class="mt-1 w-5 h-5">
                    <span class="text-gray-700">I have read and understood the instructions. I am ready to take the test.</span>
                </label>
            </div>
            
            <div class="text-center">
                <button onclick="proceedToExam()" class="btn-nta btn-proceed">
                    <i class="fas fa-arrow-right mr-2"></i>PROCEED
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== EXAM SECTION ==================== -->
    <div id="examSection" class="hidden-all">
        <div class="nta-blue text-white p-3">
            <div class="max-w-7xl mx-auto flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-orange-400 to-green-500"></div>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold">RO/ARO EXAM</h1>
                        <p class="text-xs text-blue-200">UPPSC Mock Test</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p class="text-xs text-blue-200">Candidate</p>
                        <p class="font-semibold" id="displayCandidateName">Student</p>
                    </div>
                    <div class="text-right hidden sm:block">
                        <p class="text-xs text-blue-200">Subject</p>
                        <p class="font-semibold" id="displaySubject">-</p>
                    </div>
                    <div class="timer-box">
                        <i class="fas fa-clock mr-2"></i><span id="timer">00:00:00</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="nta-orange text-white p-2">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <h2 class="font-bold" id="examTitle">Mock Test</h2>
                <span class="text-sm" id="examInfo"></span>
            </div>
        </div>
        
        <div class="max-w-7xl mx-auto p-4">
            <div class="flex flex-col lg:flex-row gap-4">
                <!-- Question Area -->
                <div class="flex-1 bg-white rounded-lg shadow p-6">
                    <div id="questionContainer">
                        <h3 class="text-lg font-bold mb-4">Question <span id="qNumber">1</span>:</h3>
                        <div id="questionText" class="text-gray-800 mb-6 text-lg leading-relaxed"></div>
                        <div id="optionsContainer" class="space-y-3"></div>
                    </div>
                    
                    <div class="mt-8 flex flex-wrap gap-3">
                        <button onclick="saveAndNext()" class="btn-nta btn-save-next">
                            <i class="fas fa-save mr-1"></i>Save & Next
                        </button>
                        <button onclick="saveAndMarkReview()" class="btn-nta btn-save-review">
                            <i class="fas fa-bookmark mr-1"></i>Save & Mark for Review
                        </button>
                        <button onclick="clearResponse()" class="btn-nta btn-clear">
                            <i class="fas fa-eraser mr-1"></i>Clear Response
                        </button>
                        <button onclick="markReviewAndNext()" class="btn-nta btn-mark-review">
                            <i class="fas fa-flag mr-1"></i>Mark for Review & Next
                        </button>
                    </div>
                    
                    <div class="mt-6 flex justify-between">
                        <button onclick="prevQuestion()" class="px-4 py-2 border-2 border-gray-300 rounded hover:bg-gray-100">
                            <i class="fas fa-chevron-left mr-1"></i>&lt;&lt; Back
                        </button>
                        <button onclick="nextQuestion()" class="px-4 py-2 border-2 border-gray-300 rounded hover:bg-gray-100">
                            Next &gt;&gt;<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Question Palette -->
                <div class="lg:w-80 bg-white rounded-lg shadow p-4">
                    <h4 class="font-bold text-gray-700 mb-3 border-b pb-2">Question Palette</h4>
                    
                    <div class="grid grid-cols-2 gap-2 mb-4 text-xs">
                        <div class="flex items-center gap-2">
                            <span class="w-6 h-6 rounded bg-gray-400 flex items-center justify-center text-white font-bold" id="statNotVisited">0</span>
                            <span>Not Visited</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-6 h-6 rounded bg-red-500 flex items-center justify-center text-white font-bold" id="statNotAnswered">0</span>
                            <span>Not Answered</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-6 h-6 rounded bg-green-500 flex items-center justify-center text-white font-bold" id="statAnswered">0</span>
                            <span>Answered</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-6 h-6 rounded bg-purple-600 flex items-center justify-center text-white font-bold" id="statMarked">0</span>
                            <span>Marked</span>
                        </div>
                    </div>
                    
                    <div id="questionPalette" class="grid grid-cols-5 gap-2 max-h-80 overflow-y-auto p-2"></div>
                    
                    <button onclick="confirmSubmit()" class="w-full mt-4 btn-nta btn-submit py-3">
                        <i class="fas fa-check-circle mr-2"></i>SUBMIT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SUBMIT MODAL ==================== -->
    <div id="submitModal" class="hidden-all fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-center mb-4">Exam Summary</h3>
            <table class="w-full mb-6 text-sm">
                <thead class="bg-gray-100">
                    <tr><th class="p-2 text-left">Status</th><th class="p-2 text-center">Count</th></tr>
                </thead>
                <tbody id="summaryTable"></tbody>
            </table>
            <p class="text-center text-gray-700 mb-4 font-semibold">
                Are you sure you want to submit?<br>
                <span class="text-red-600 text-sm">No changes allowed after submission.</span>
            </p>
            <div class="flex justify-center gap-4">
                <button onclick="finalSubmit()" class="px-6 py-2 bg-green-500 text-white rounded hover:bg-green-600 font-semibold">YES</button>
                <button onclick="closeSubmitModal()" class="px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 font-semibold">NO</button>
            </div>
        </div>
    </div>

    <!-- ==================== RESULT SECTION ==================== -->
    <div id="resultSection" class="hidden-all">
        <div class="nta-blue text-white p-4">
            <div class="max-w-7xl mx-auto text-center">
                <h1 class="text-2xl font-bold">RO/ARO EXAM PORTAL</h1>
                <p class="text-blue-200">UPPSC Mock Test Results</p>
            </div>
        </div>
        
        <div class="max-w-5xl mx-auto p-6">
            <h2 class="text-2xl font-bold text-center mb-6">Result</h2>
            
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <p class="text-gray-600 text-sm">Total Questions</p>
                        <p class="text-2xl font-bold text-blue-600" id="resTotal">0</p>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <p class="text-gray-600 text-sm">Correct (SAHI)</p>
                        <p class="text-2xl font-bold text-green-600" id="resCorrect">0</p>
                    </div>
                    <div class="text-center p-4 bg-red-50 rounded-lg">
                        <p class="text-gray-600 text-sm">Wrong (GALAT)</p>
                        <p class="text-2xl font-bold text-red-600" id="resWrong">0</p>
                    </div>
                    <div class="text-center p-4 bg-yellow-50 rounded-lg">
                        <p class="text-gray-600 text-sm">Unattempted</p>
                        <p class="text-2xl font-bold text-yellow-600" id="resUnattempted">0</p>
                    </div>
                </div>
                
                <div class="text-center p-6 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg text-white">
                    <p class="text-lg mb-2">Final Score</p>
                    <p class="text-5xl font-bold" id="resScore">0.00</p>
                    <p class="text-sm mt-2 opacity-80">(+1 for correct, -0.33 for wrong)</p>
                </div>
                
                <div class="mt-6 text-center">
                    <button onclick="restartTest()" class="btn-nta btn-proceed mr-3">
                        <i class="fas fa-redo mr-2"></i>Take Test Again
                    </button>
                    <button onclick="newTest()" class="btn-nta bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded">
                        <i class="fas fa-home mr-2"></i>New Test
                    </button>
                </div>
            </div>
            
            <h3 class="text-xl font-bold mb-4 text-red-600">
                <i class="fas fa-times-circle mr-2"></i>Wrong Answers (Review with Explanation)
            </h3>
            <div id="wrongQuestionsList" class="space-y-4 mb-8"></div>
            
            <h3 class="text-xl font-bold mb-4 text-green-600">
                <i class="fas fa-check-circle mr-2"></i>Correct Answers
            </h3>
            <div id="correctQuestionsList" class="space-y-4 mb-8"></div>
            
            <h3 class="text-xl font-bold mb-4 text-gray-600">
                <i class="fas fa-minus-circle mr-2"></i>Unattempted Questions
            </h3>
            <div id="skippedQuestionsList" class="space-y-4"></div>
        </div>
    </div>

    <script>
        // ==================== CONFIG (HIDDEN) ====================
        const CONFIG = {
            PASSWORD: '208025',
            SHEET_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSEOVpeHlnybWhmMduLnfUW96Xw-H2g0NUnFEUxTn8CK0cF4A7Bl8nre39W4fzH0pzg7tPwXJa6cFf6/pub?output=csv'
        };
        
        // ==================== GLOBALS ====================
        let allQuestions = [];
        let filteredQuestions = [];
        let currentQuestions = [];
        let userAnswers = [];
        let questionStatus = [];
        let currentIndex = 0;
        let timerInterval;
        let timeRemaining = 0;
        let selectedOption = null;
        let hasEnglishColumns = false;
        let candidateName = '';
        let selectedQuestionCount = 0;
        
        // ==================== PASSWORD ====================
        function checkPass() {
            if (document.getElementById('sitePass').value === CONFIG.PASSWORD) {
                document.getElementById('passwordOverlay').classList.add('hidden-all');
                document.getElementById('nameSection').classList.remove('hidden-all');
            } else {
                document.getElementById('passError').classList.remove('hidden');
            }
        }
        
        // ==================== NAME SECTION ====================
        function proceedToSubject() {
            const name = document.getElementById('candidateName').value.trim();
            if (!name) {
                alert('Please enter your name!');
                return;
            }
            candidateName = name;
            document.getElementById('nameSection').classList.add('hidden-all');
            document.getElementById('loadingSection').classList.remove('hidden-all');
            loadData();
        }
        
        // ==================== LOAD DATA ====================
        function loadData() {
            Papa.parse(CONFIG.SHEET_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        allQuestions = results.data.filter(q => q.Question && q.Question.trim() !== '');
                        
                        // Check for English columns
                        hasEnglishColumns = allQuestions.length > 0 && (
                            'English_Question' in allQuestions[0] || 
                            'English Question' in allQuestions[0]
                        );
                        
                        populateSubjects();
                        document.getElementById('loadingSection').classList.add('hidden-all');
                        document.getElementById('subjectSection').classList.remove('hidden-all');
                    }
                },
                error: function(err) {
                    alert('Error loading data: ' + err.message);
                }
            });
        }
        
        function populateSubjects() {
            const subjects = [...new Set(allQuestions.map(q => q.Subject))].filter(s => s).sort();
            const select = document.getElementById('mainSubject');
            select.innerHTML = '<option value="">-- Select Subject --</option>';
            subjects.forEach(s => select.innerHTML += `<option value="${s}">${s}</option>`);
        }
        
        function updateSubSubjects() {
            const subject = document.getElementById('mainSubject').value;
            const container = document.getElementById('subSubjectContainer');
            const subSelect = document.getElementById('subSubject');
            
            // Reset question count and time display
            document.getElementById('questionCount').value = '';
            document.getElementById('timeDisplay').classList.add('hidden');
            
            if (!subject) { container.classList.add('hidden'); return; }
            
            const subSubjects = [...new Set(allQuestions
                .filter(q => q.Subject === subject)
                .map(q => q['Sub-Subject'] || q.SubSubject || q.Topic)
                .filter(s => s))].sort();
            
            if (subSubjects.length > 0) {
                container.classList.remove('hidden');
                subSelect.innerHTML = '<option value="">-- All Topics --</option>';
                subSubjects.forEach(s => subSelect.innerHTML += `<option value="${s}">${s}</option>`);
            } else {
                container.classList.add('hidden');
            }
        }
        
        function updateQuestionCount() {
            // Reset question count when sub-subject changes
            document.getElementById('questionCount').value = '';
            document.getElementById('timeDisplay').classList.add('hidden');
        }
        
        function updateTimeDisplay() {
            const count = document.getElementById('questionCount').value;
            const timeDisplay = document.getElementById('timeDisplay');
            const totalTimeSpan = document.getElementById('totalTime');
            
            if (!count) {
                timeDisplay.classList.add('hidden');
                return;
            }
            
            // Get available questions count
            const subject = document.getElementById('mainSubject').value;
            const subSubject = document.getElementById('subSubject').value;
            
            let availableQuestions = allQuestions.filter(q => {
                if (q.Subject !== subject) return false;
                if (subSubject) {
                    const qSub = q['Sub-Subject'] || q.SubSubject || q.Topic;
                    if (qSub !== subSubject) return false;
                }
                return true;
            }).length;
            
            let displayCount;
            if (count === 'all') {
                displayCount = availableQuestions;
            } else {
                displayCount = Math.min(parseInt(count), availableQuestions);
            }
            
            // Calculate time (1 minute per question)
            const hours = Math.floor(displayCount / 60);
            const mins = displayCount % 60;
            
            let timeText = '';
            if (hours > 0) {
                timeText = `${hours} hour${hours > 1 ? 's' : ''} ${mins} minute${mins > 1 ? 's' : ''}`;
            } else {
                timeText = `${mins} minute${mins > 1 ? 's' : ''}`;
            }
            
            totalTimeSpan.textContent = `${timeText} (${displayCount} questions)`;
            timeDisplay.classList.remove('hidden');
        }
        
        // ==================== START EXAM ====================
        function startExam() {
            const subject = document.getElementById('mainSubject').value;
            const subSubject = document.getElementById('subSubject').value;
            const count = document.getElementById('questionCount').value;
            const lang = document.getElementById('languageSelect').value;
            
            if (!subject) { alert('Please select a subject!'); return; }
            if (!count) { alert('Please select number of questions!'); return; }
            
            // Check if English is selected but not available
            if (lang === 'en' && !hasEnglishColumns) {
                document.getElementById('languageSelect').value = 'hi';
            }
            
            // Filter questions
            filteredQuestions = allQuestions.filter(q => {
                if (q.Subject !== subject) return false;
                if (subSubject) {
                    const qSub = q['Sub-Subject'] || q.SubSubject || q.Topic;
                    if (qSub !== subSubject) return false;
                }
                return true;
            });
            
            if (filteredQuestions.length === 0) { alert('No questions found!'); return; }
            
            // SHUFFLE QUESTIONS
            filteredQuestions = shuffleArray([...filteredQuestions]);
            
            // Apply question count
            if (count === 'all') {
                currentQuestions = filteredQuestions;
                selectedQuestionCount = filteredQuestions.length;
            } else {
                selectedQuestionCount = Math.min(parseInt(count), filteredQuestions.length);
                currentQuestions = filteredQuestions.slice(0, selectedQuestionCount);
            }
            
            userAnswers = new Array(currentQuestions.length).fill(null);
            questionStatus = new Array(currentQuestions.length).fill('not-visited');
            currentIndex = 0;
            
            // Update displays
            document.getElementById('displayCandidateName').textContent = candidateName;
            document.getElementById('displaySubject').textContent = subject;
            document.getElementById('examTitle').textContent = subSubject || subject;
            document.getElementById('examInfo').textContent = `${currentQuestions.length} Questions | ${formatTime(currentQuestions.length * 60)}`;
            
            // Update instructions time
            document.getElementById('instrTotalTime').textContent = formatTime(currentQuestions.length * 60);
            
            document.getElementById('subjectSection').classList.add('hidden-all');
            document.getElementById('instructionSection').classList.remove('hidden-all');
        }
        
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            
            if (h > 0) {
                return `${h}h ${m}m`;
            }
            return `${m} minutes`;
        }
        
        function proceedToExam() {
            if (!document.getElementById('declaration').checked) {
                alert('Please accept the declaration!');
                return;
            }
            
            document.getElementById('instructionSection').classList.add('hidden-all');
            document.getElementById('examSection').classList.remove('hidden-all');
            
            // Set time: 1 minute per question
            timeRemaining = currentQuestions.length * 60;
            startTimer();
            renderQuestion();
            renderPalette();
            updateStats();
        }
        
        // ==================== TIMER ====================
        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    alert('Time up! Submitting...');
                    finalSubmit();
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const h = Math.floor(timeRemaining / 3600);
            const m = Math.floor((timeRemaining % 3600) / 60);
            const s = timeRemaining % 60;
            document.getElementById('timer').textContent = 
                `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }
        
        // ==================== GET TEXT (Hindi/English) ====================
        function getQuestionText(q) {
            const lang = document.getElementById('languageSelect').value;
            const useEnglish = lang === 'en' && hasEnglishColumns;
            
            return {
                question: useEnglish ? (q['English_Question'] || q['English Question'] || q.Question) : q.Question,
                explanation: useEnglish ? (q['English_Explanation'] || q['English Explanation'] || q.Explanation || 'No explanation available.') : (q.Explanation || 'व्याख्या उपलब्ध नहीं है।'),
                options: {
                    A: useEnglish ? (q['English_Option_A'] || q['English Option A'] || q['Option A'] || q['OptionA'] || q.A) : (q['Option A'] || q['OptionA'] || q.A),
                    B: useEnglish ? (q['English_Option_B'] || q['English Option B'] || q['Option B'] || q['OptionB'] || q.B) : (q['Option B'] || q['OptionB'] || q.B),
                    C: useEnglish ? (q['English_Option_C'] || q['English Option C'] || q['Option C'] || q['OptionC'] || q.C) : (q['Option C'] || q['OptionC'] || q.C),
                    D: useEnglish ? (q['English_Option_D'] || q['English Option D'] || q['Option D'] || q['OptionD'] || q.D) : (q['Option D'] || q['OptionD'] || q.D)
                }
            };
        }
        
        // ==================== RENDER QUESTION ====================
        function renderQuestion() {
            const q = currentQuestions[currentIndex];
            const text = getQuestionText(q);
            
            document.getElementById('qNumber').textContent = currentIndex + 1;
            document.getElementById('questionText').innerHTML = text.question;
            
            if (questionStatus[currentIndex] === 'not-visited') {
                questionStatus[currentIndex] = 'not-answered';
            }
            
            const optionsDiv = document.getElementById('optionsContainer');
            optionsDiv.innerHTML = '';
            
            ['A', 'B', 'C', 'D'].forEach((opt, idx) => {
                const optText = text.options[opt];
                if (!optText) return;
                
                const label = document.createElement('label');
                label.className = 'option-label';
                if (userAnswers[currentIndex] === (idx + 1).toString()) {
                    label.classList.add('selected');
                }
                label.onclick = () => selectOption((idx + 1).toString());
                
                label.innerHTML = `
                    <div class="option-circle">${opt}</div>
                    <div class="flex-1">${optText}</div>
                    <input type="radio" name="option" value="${idx + 1}" class="hidden" 
                        ${userAnswers[currentIndex] === (idx + 1).toString() ? 'checked' : ''}>
                `;
                optionsDiv.appendChild(label);
            });
            
            selectedOption = userAnswers[currentIndex];
            renderPalette();
            updateStats();
        }
        
        function selectOption(value) {
            selectedOption = value;
            userAnswers[currentIndex] = value;
            questionStatus[currentIndex] = 'answered';
            renderQuestion();
        }
        
        function renderPalette() {
            const palette = document.getElementById('questionPalette');
            palette.innerHTML = '';
            
            for (let i = 0; i < currentQuestions.length; i++) {
                const btn = document.createElement('button');
                btn.className = 'palette-btn';
                btn.textContent = i + 1;
                
                let statusClass = 'palette-not-visited';
                if (questionStatus[i] === 'not-answered') statusClass = 'palette-not-answered';
                else if (questionStatus[i] === 'answered') statusClass = 'palette-answered';
                else if (questionStatus[i] === 'marked') statusClass = 'palette-marked';
                else if (questionStatus[i] === 'answered-marked') statusClass = 'palette-answered-marked';
                btn.classList.add(statusClass);
                
                if (i === currentIndex) btn.classList.add('palette-current');
                btn.onclick = () => { currentIndex = i; renderQuestion(); };
                palette.appendChild(btn);
            }
        }
        
        function updateStats() {
            document.getElementById('statNotVisited').textContent = questionStatus.filter(s => s === 'not-visited').length;
            document.getElementById('statNotAnswered').textContent = questionStatus.filter(s => s === 'not-answered').length;
            document.getElementById('statAnswered').textContent = questionStatus.filter(s => s === 'answered').length;
            document.getElementById('statMarked').textContent = questionStatus.filter(s => s === 'marked' || s === 'answered-marked').length;
        }
        
        // ==================== BUTTONS ====================
        function saveAndNext() {
            if (selectedOption) {
                userAnswers[currentIndex] = selectedOption;
                questionStatus[currentIndex] = 'answered';
            }
            if (currentIndex < currentQuestions.length - 1) { currentIndex++; renderQuestion(); }
        }
        
        function saveAndMarkReview() {
            if (selectedOption) {
                userAnswers[currentIndex] = selectedOption;
                questionStatus[currentIndex] = 'answered-marked';
            }
            if (currentIndex < currentQuestions.length - 1) { currentIndex++; renderQuestion(); }
        }
        
        function clearResponse() {
            selectedOption = null;
            userAnswers[currentIndex] = null;
            questionStatus[currentIndex] = 'not-answered';
            renderQuestion();
        }
        
        function markReviewAndNext() {
            if (selectedOption) {
                userAnswers[currentIndex] = selectedOption;
                questionStatus[currentIndex] = 'answered-marked';
            } else {
                questionStatus[currentIndex] = 'marked';
            }
            if (currentIndex < currentQuestions.length - 1) { currentIndex++; renderQuestion(); }
        }
        
        function nextQuestion() {
            if (currentIndex < currentQuestions.length - 1) { currentIndex++; renderQuestion(); }
        }
        
        function prevQuestion() {
            if (currentIndex > 0) { currentIndex--; renderQuestion(); }
        }
        
        // ==================== SUBMIT ====================
        function confirmSubmit() {
            const stats = {
                answered: questionStatus.filter(s => s === 'answered' || s === 'answered-marked').length,
                notAnswered: questionStatus.filter(s => s === 'not-answered').length,
                marked: questionStatus.filter(s => s === 'marked').length,
                notVisited: questionStatus.filter(s => s === 'not-visited').length
            };
            
            document.getElementById('summaryTable').innerHTML = `
                <tr><td class="p-2 border">Answered</td><td class="p-2 border text-center">${stats.answered}</td></tr>
                <tr><td class="p-2 border">Not Answered</td><td class="p-2 border text-center">${stats.notAnswered}</td></tr>
                <tr><td class="p-2 border">Marked for Review</td><td class="p-2 border text-center">${stats.marked}</td></tr>
                <tr><td class="p-2 border">Not Visited</td><td class="p-2 border text-center">${stats.notVisited}</td></tr>
                <tr class="bg-gray-100 font-bold"><td class="p-2 border">Total</td><td class="p-2 border text-center">${currentQuestions.length}</td></tr>
            `;
            
            document.getElementById('submitModal').classList.remove('hidden-all');
        }
        
        function closeSubmitModal() {
            document.getElementById('submitModal').classList.add('hidden-all');
        }
        
        function finalSubmit() {
            clearInterval(timerInterval);
            closeSubmitModal();
            showResults();
        }
        
        // ==================== RESULTS ====================
        function showResults() {
            document.getElementById('examSection').classList.add('hidden-all');
            document.getElementById('resultSection').classList.remove('hidden-all');
            
            let correct = 0, wrong = 0, unattempted = 0;
            const wrongQuestions = [];
            const correctQuestions = [];
            const skippedQuestions = [];
            
            currentQuestions.forEach((q, i) => {
                const userAns = userAnswers[i];
                const correctAns = (q.Answer || '').toString().trim().toLowerCase();
                
                let correctNum = '';
                if (correctAns === 'a' || correctAns === '1') correctNum = '1';
                else if (correctAns === 'b' || correctAns === '2') correctNum = '2';
                else if (correctAns === 'c' || correctAns === '3') correctNum = '3';
                else if (correctAns === 'd' || correctAns === '4') correctNum = '4';
                
                const text = getQuestionText(q);
                
                const result = {
                    index: i + 1,
                    question: text.question,
                    userAnswer: userAns,
                    correctAnswer: correctNum,
                    correctText: text.options[correctAns.toUpperCase()],
                    explanation: text.explanation,
                    options: text.options
                };
                
                if (!userAns) {
                    unattempted++;
                    skippedQuestions.push(result);
                } else if (userAns === correctNum) {
                    correct++;
                    correctQuestions.push(result);
                } else {
                    wrong++;
                    wrongQuestions.push(result);
                }
            });
            
            const score = correct - (wrong * 0.33);
            
            document.getElementById('resTotal').textContent = currentQuestions.length;
            document.getElementById('resCorrect').textContent = correct;
            document.getElementById('resWrong').textContent = wrong;
            document.getElementById('resUnattempted').textContent = unattempted;
            document.getElementById('resScore').textContent = score.toFixed(2);
            
            renderList('wrongQuestionsList', wrongQuestions, 'wrong');
            renderList('correctQuestionsList', correctQuestions, 'correct');
            renderList('skippedQuestionsList', skippedQuestions, 'skipped');
        }
        
        function renderList(containerId, questions, type) {
            const container = document.getElementById(containerId);
            if (questions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">No questions in this category.</p>';
                return;
            }
            
            const lang = document.getElementById('languageSelect').value;
            const isHindi = lang === 'hi' || !hasEnglishColumns;
            
            container.innerHTML = questions.map(q => {
                const userOpt = q.userAnswer ? ['A', 'B', 'C', 'D'][q.userAnswer - 1] : '-';
                const correctOpt = ['A', 'B', 'C', 'D'][q.correctAnswer - 1];
                
                let statusHtml = '';
                if (type === 'wrong') statusHtml = `<span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-bold">${isHindi ? 'गलत' : 'WRONG'}</span>`;
                else if (type === 'correct') statusHtml = `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold">${isHindi ? 'सही' : 'CORRECT'}</span>`;
                else statusHtml = `<span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-bold">${isHindi ? 'अनुत्तरित' : 'UNATTEMPTED'}</span>`;
                
                const qLabel = isHindi ? 'प्रश्न' : 'Question';
                const correctLabel = isHindi ? 'सही उत्तर' : 'Correct Answer';
                const yourLabel = isHindi ? 'आपका उत्तर' : 'Your Answer';
                const expLabel = isHindi ? 'व्याख्या' : 'Explanation';
                
                return `
                    <div class="bg-white rounded-lg shadow p-4 result-${type}">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-bold text-gray-800">${qLabel} ${q.index}</h4>
                            ${statusHtml}
                        </div>
                        <p class="text-gray-700 mb-3">${q.question}</p>
                        <div class="grid md:grid-cols-2 gap-2 mb-3 text-sm">
                            <div class="bg-green-50 p-2 rounded border border-green-200">
                                <span class="font-semibold text-green-700">${correctLabel}: ${correctOpt}</span>
                                <p class="text-gray-600">${q.options[correctOpt] || ''}</p>
                            </div>
                            ${type === 'wrong' ? `
                            <div class="bg-red-50 p-2 rounded border border-red-200">
                                <span class="font-semibold text-red-700">${yourLabel}: ${userOpt}</span>
                                <p class="text-gray-600">${q.options[userOpt] || (isHindi ? 'प्रयास नहीं किया' : 'Not attempted')}</p>
                            </div>
                            ` : ''}
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <p class="font-semibold text-blue-700 mb-1"><i class="fas fa-lightbulb mr-2"></i>${expLabel}:</p>
                            <p class="text-gray-700 text-sm">${q.explanation}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ==================== UTILITY ====================
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        function restartTest() {
            userAnswers = new Array(currentQuestions.length).fill(null);
            questionStatus = new Array(currentQuestions.length).fill('not-visited');
            currentIndex = 0;
            selectedOption = null;
            
            // Re-shuffle for new test
            currentQuestions = shuffleArray([...currentQuestions]);
            
            document.getElementById('resultSection').classList.add('hidden-all');
            document.getElementById('examSection').classList.remove('hidden-all');
            
            timeRemaining = currentQuestions.length * 60;
            startTimer();
            renderQuestion();
            renderPalette();
            updateStats();
        }
        
        function newTest() {
            location.reload();
        }
    </script>
</body>
</html>
